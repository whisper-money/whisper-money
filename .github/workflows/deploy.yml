name: deploy

on:
  workflow_run:
    workflows: [tests, linter]
    types:
      - completed
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: >
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.head_branch == 'main'
    steps:
      - name: Check all workflows passed
        id: check-workflows
        uses: actions/github-script@v7
        with:
          script: |
            const { data: runs } = await github.rest.actions.listWorkflowRunsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              branch: 'main',
              per_page: 10,
            });

            const headSha = context.payload.workflow_run.head_sha;
            const requiredWorkflows = ['tests', 'linter'];

            for (const workflow of requiredWorkflows) {
              const workflowRuns = runs.workflow_runs.filter(
                run => run.name === workflow && run.head_sha === headSha
              );

              if (workflowRuns.length === 0) {
                core.setFailed(`No run found for workflow: ${workflow}`);
                return;
              }

              const latestRun = workflowRuns[0];
              if (latestRun.conclusion !== 'success') {
                core.setFailed(`Workflow ${workflow} did not succeed: ${latestRun.conclusion}`);
                return;
              }
            }

            core.info('All required workflows passed!');

      - name: Trigger deployment
        run: |
          response=$(curl -s -w "\n%{http_code}" \
            -H "Authorization: Bearer ${{ secrets.DEPLOYMENT_TOKEN }}" \
            "http://147.93.126.54:8000/api/v1/deploy?uuid=ww00sswosco8w80k08c0occ8&force=false")

          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')

          echo "Response: $body"
          echo "HTTP Status: $http_code"

          if [ "$http_code" -lt 200 ] || [ "$http_code" -ge 300 ]; then
            echo "Deployment request failed with status $http_code"
            exit 1
          fi

          echo "Deployment triggered successfully!"

